<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>UAV Cloud Monitor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./css/style.css" />
</head>
<body>
  <h2>UAV Cloud Monitor（远程实时监测）</h2>

  <div class="row">
    <div class="card">
      <div class="muted">WSS Host / Port / Path</div>
      <div class="grid3">
        <input id="host" placeholder="host" />
        <input id="port" placeholder="port" />
        <input id="path" placeholder="/mqtt" />
      </div>
      <div class="muted small" style="margin-top:6px;">例：wss://host:8884/mqtt</div>
    </div>

    <div class="card">
      <div class="muted">Username / Password</div>
      <input id="user" placeholder="username" style="margin-bottom:8px;" />
      <input id="pass" type="password" placeholder="password" />
      <div class="muted small" style="margin-top:6px;">
        只读账号：uav-viewer
        密码：123456qwertyAd@
      </div>
    </div>

    <div class="card">
      <div class="muted">Topic / Points</div>
      <input id="topic" placeholder="topic" style="margin-bottom:8px;" />
      <input id="maxPoints" placeholder="max points" />
    </div>

    <div class="card">
      <div class="muted">Status</div>
      <div id="st" class="bad">disconnected</div>
      <div class="btnrow">
        <button id="btnConn">Connect</button>
        <button id="btnDis">Disconnect</button>
        <button id="btnClear">Clear</button>
      </div>
      <div class="muted small" id="hint"></div>
      <div class="muted small" id="onlineSummary"></div>
    </div>

    <div class="card" style="min-width:280px;">
      <div class="muted">设备选择</div>
      <select id="deviceSel">
        <option value="__all__">全部设备（ALL）</option>
      </select>
      <div class="muted small" style="margin-top:6px;">自动识别云端 topic 的 device 段</div>
    </div>
  </div>

  <div class="grid2" style="margin-top:12px;">
    <div>
      <h3>当前设备卡片（随设备选择变化）</h3>
      <div id="cards" class="cards"></div>

      <h3 style="margin-top:12px;">设备面板（全部设备）</h3>
      <div id="devicePanels" class="panels"></div>
    </div>
    <div>
      <h3>CO₂ 折线图</h3>
      <div id="chartWrap">
        <canvas id="co2Chart"></canvas>
        <div class="muted small" id="chartNote">-</div>
      </div>
    </div>
  </div>

  <div class="grid2" style="margin-top:12px;">
    <div>
      <h3>Latest message</h3>
      <div class="muted" id="meta">-</div>
      <pre id="out">{}</pre>
    </div>
    <div>
      <h3>Tips</h3>
      <div class="muted">
        建议把这个站点部署到 GitHub Pages / Cloudflare Pages。<br/>
        访问者只要打开网址，填账号密码，点 Connect 就能看实时数据。
      </div>
    </div>
  </div>

  <div class="grid2" style="margin-top:12px;">
    <div>
      <h3>历史数据（从田边电脑按天 CSV 拉取）</h3>
      <div class="card" style="min-width:auto;">
        <div class="row" style="align-items:end;">
          <div style="min-width:220px;">
            <div class="muted">Device</div>
            <select id="histDevice">
              <option value="">（从上方设备下拉同步）</option>
            </select>
          </div>

          <div style="min-width:220px;">
            <div class="muted">Date</div>
            <input id="histDate" type="date" />
          </div>

          <div style="min-width:220px;">
            <div class="muted">动作</div>
            <div class="btnrow">
              <button id="btnFetchCsv">Fetch CSV</button>
              <button id="btnListDates">List Dates</button>
            </div>
          </div>
        </div>

        <div class="muted small" style="margin-top:8px;">
          说明：网页通过 HiveMQ 发请求，田边电脑读取本地 <code>data/&lt;device&gt;/YYYY-MM-DD.csv</code> 分片回传，然后网页拼接并下载。
        </div>

        <div style="margin-top:10px;">
          <div class="muted">Progress</div>
          <div class="progress">
            <div id="histBar" class="progressBar" style="width:0%"></div>
          </div>
          <div id="histStatus" class="muted small" style="margin-top:6px;">-</div>
        </div>

        <div style="margin-top:10px;">
          <div class="muted">可用日期（来自田边电脑扫描）</div>
          <div id="histDates" class="dates"></div>
        </div>
      </div>
    </div>

    <div>
      <h3>注意</h3>
      <div class="muted">
        这版历史功能依赖田边电脑在线：田边电脑关机或断网时，历史拉取会失败。<br/>
        后续我们再加“云端落地”后，就不依赖田边电脑了。
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script type="module" src="./js/app.js"></script>
</body>
</html>
